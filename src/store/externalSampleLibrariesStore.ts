import factorySampleKits from "@/_autogenerated_samples";
import { SampleFileDefinition } from "@/synth/features/chromaticSampleKitUser";
import { defineStore } from "pinia";
import { ref } from "vue";

// { library [ kits [ samples ] ]  }


/**
 * A list of samples to distribute accross
 * frequencies, with some metadata
 */
export interface SampleKitDefinition {
    type?: 'chromatic' | 'atonal';
    name: string,
    exclusive?: boolean;
    onlyLocal?: boolean;
    readme?: string;
    samples: SampleFileDefinition[];
    fromLibrary: string;
}

const requireAttributes = (obj: Object, attributes: string[], guideStr: string) => {
    for (const attr of attributes) {
        if (!obj.hasOwnProperty(attr)) {
            throw new Error(`Object must have attribute ${attr} in ${guideStr}`);
        }
    }
}

export default defineStore('externalSampleLibrariesStore', () => {
    const listOfExternalLibs = ref([] as string[]);

    const listOfAvailableSampleKits = ref([
        ...factorySampleKits,
    ] as SampleKitDefinition[]);

    const checkLibraryDef = (def: unknown): SampleKitDefinition => {
        if (def === null) {
            throw new Error('Library definition is null');
        }

        // @ts-ignore
        requireAttributes(def, ['name', 'samples', 'fromLibrary'], 'Library definition');

        if (typeof def !== 'object') {
            throw new Error('Library definition must be an object');
        }
        // @ts-ignore
        if (!Array.isArray(def['samples'])) {
            throw new Error('Library definition samples property must be an array');
        }
        // @ts-ignore
        if (def.samples.some((s: unknown) => typeof s !== 'object')) {
            throw new Error('Library definition samples property must be an array of objects');
        }

        // @ts-ignore
        def.samples.forEach((s: unknown) => {
            if (s === null) {
                // @ts-ignore
                throw new Error('Sample definition is null in ' + def.name);
            }
            if (typeof s !== 'object') {
                throw new Error('Sample definition must be an object');
            }
            // @ts-ignore
            requireAttributes(s, ['frequency', 'path', 'name', 'frequencyStart', 'frequencyEnd', 'velocityStart', 'velocityEnd'], def.name);

            if ('frequencyEnd' in s && s.frequencyEnd === null) s.frequencyEnd = Infinity;
            if ('velocityEnd' in s && s.velocityEnd === null) s.velocityEnd = Infinity;
        })
        return def as SampleKitDefinition;
    }

    const addLibraryUrl = async (definitionUrl: string) => {
        console.log("add library", definitionUrl);
        const newDef = await fetch(definitionUrl).then(res => res.json());
        console.log("newDef", newDef);
        if (!Array.isArray(newDef)) {
            throw new Error('Library definition must be an array, instead got ' + typeof newDef);
        }
        const checkedList = [];
        for (const def of newDef) {
            checkedList.push(checkLibraryDef(def));
        }

        listOfExternalLibs.value.push(definitionUrl);
        listOfAvailableSampleKits.value = [...listOfAvailableSampleKits.value, ...checkedList];
    }

    const removeLibraryUrl = (definitionUrl: string) => {
        listOfExternalLibs.value = listOfExternalLibs.value.filter(url => url !== definitionUrl);
        listOfAvailableSampleKits.value = listOfAvailableSampleKits.value.filter(kit => !kit.onlyLocal);
    }

    addLibraryUrl('http://127.0.0.1:3010/generate-samples');

    return {
        listOfExternalLibs,
        listOfAvailableSampleKits,
        addLibraryUrl,
    }
});